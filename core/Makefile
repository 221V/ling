.PHONY: default lwip nettle pcre
INCLUDES := premod.inc code_base.inc include/mod_info.inc preload/literals.c catch_tab.inc
default: lwip pcre nettle $(INCLUDES) vmling.o

include ../Config.mk
include Compiler.mk

CPPFLAGS := -D_ISOC99_SOURCE -D_GNU_SOURCE

CPPFLAGS += -DLING_VER=$(LING_VER)

ifdef LING_DEBUG
CPPFLAGS += -DLING_DEBUG
CPPFLAGS += -DDEBUG_UNUSED_MEM
CPPFLAGS += -DTRACE_HARNESS
endif

CPPFLAGS += -isystem lib/nettle
CPPFLAGS += -isystem lib/pcre
CPPFLAGS += -isystem lib
CPPFLAGS += -iquote include -iquote arch/$(ARCH)/include
CPPFLAGS += -iquote bignum
CPPFLAGS += -isystem lib/misc/include
CPPFLAGS += -iquote lib/lwip/src/include
CPPFLAGS += -iquote lib/lwip/src/include/ipv4
CPPFLAGS += -iquote lib/lwip/src/include/ipv6
CPPFLAGS += -iquote lib/lwip/ling

CFLAGS := -Wall -Werror -Wno-nonnull -std=gnu99 -gdwarf-3
CFLAGS += -fno-omit-frame-pointer

ASFLAGS := -D__ASSEMBLY__

ifeq ($(ARCH),posix)
CPPFLAGS += -DLING_POSIX
F_NO_REORDER_BLOCKS :=
else
F_NO_REORDER_BLOCKS := -fno-reorder-blocks
CFLAGS += -fno-stack-protector -U_FORTIFY_SOURCE -ffreestanding
endif

ifeq ($(ARCH),x86)
CPPFLAGS += -DLING_XEN
CPPFLAGS += -D__XEN_INTERFACE_VERSION__=$(XEN_INTERFACE_VERSION)
CFLAGS += -fexcess-precision=standard -frounding-math -mfpmath=sse -msse2
CFLAGS += -Wno-nonnull -Wno-strict-aliasing
endif

ifeq ($(ARCH),arm)
CPPFLAGS += -DLING_ARM
CFLAGS  += -mfpu=vfp -mfloat-abi=hard -march=armv6zk -mtune=arm1176jzf-s
ASFLAGS += -mfpu=vfp -mfloat-abi=hard -march=armv6zk -mtune=arm1176jzf-s
endif

# relocatable (partial linking)
LDFLAGS := -Xlinker -r

ifneq ($(ARCH),posix)
LDFLAGS += -T arch/$(ARCH)/ling.lds
LDFLAGS += -static
LDFLAGS += -Xlinker --build-id=none
LDFLAGS += -Xlinker --cref -Xlinker -Map=ling.map
LDFLAGS += -nostdlib
LDFLAGS_FINAL := -lgcc
LDFLAGS_FINAL += lib/nettle/libnettle.a
else
#LDFLAGS_FINAL := -lnettle -L/usr/local/lib
endif

ifeq ($(ARCH),posix)
STARTUP_OBJ :=
else
STARTUP_OBJ := arch/$(ARCH)/startup.o
ifeq ($(ARCH),x86)
STARTUP_SRC_EXT = S
else
STARTUP_SRC_EXT = s
endif
endif

ARCH_OBJS := $(patsubst %.c,%.o,$(wildcard arch/$(ARCH)/*.c))
# ling_main.c is autogenerated
OBJS := $(filter-out ling_main.%,$(patsubst %.c,%.o,$(wildcard *.c))) preload/literals.o
BIGNUM_OBJS := $(patsubst %.c,%.o,$(wildcard bignum/*.c))

MISC_SRCS :=
MISC_SRCS += __cos.c __expo2.c __rem_pio2.c __rem_pio2_large.c __sin.c __tan.c
MISC_SRCS += acos.c asin.c atan.c atan2.c atof.c cos.c cosh.c exp.c expm1.c fabs.c
MISC_SRCS += floor.c log.c log10.c memcmp.c modf.c pow.c
MISC_SRCS += qsort.c scalbln.c scalbn.c sin.c sinh.c stpcpy.c strcat.c strchr.c
MISC_SRCS += strchrnul.c strcmp.c strcpy.c strlen.c strncmp.c strtod.c tan.c tanh.c

ifneq ($(ARCH),x86)
MISC_SRCS += memcpy.c memmove.c memset.c sqrt.c
endif

ifneq ($(ARCH),posix)
# posix currently uses system libc
MISC_OBJS := $(patsubst %.c,%.o,$(addprefix lib/misc/,$(MISC_SRCS)))
MISC_AS_OBJS := $(patsubst %.s,%.o,$(wildcard lib/misc/arch/$(ARCH)/*.s))
else
MISC_OBJS :=
MISC_AS_OBJS :=
endif

PCRE_OBJS := \
	lib/pcre/pcre_chartables.o \
	lib/pcre/pcre_compile.o \
	lib/pcre/pcre_config.o \
	lib/pcre/pcre_dfa_exec.o \
	lib/pcre/pcre_exec.o \
	lib/pcre/pcre_fullinfo.o \
	lib/pcre/pcre_get.o \
	lib/pcre/pcre_globals.o \
	lib/pcre/pcre_maketables.o \
	lib/pcre/pcre_newline.o \
	lib/pcre/pcre_ord2utf8.o \
	lib/pcre/pcre_study.o \
	lib/pcre/pcre_tables.o \
	lib/pcre/pcre_try_flipped.o \
	lib/pcre/pcre_ucp_searchfuncs.o \
	lib/pcre/pcre_valid_utf8.o \
	lib/pcre/pcre_version.o \
	lib/pcre/pcre_xclass.o

LWIP_SRC_DIRS := \
	lib/lwip/src/api \
	lib/lwip/src/core \
	lib/lwip/src/core/ipv4 \
	lib/lwip/src/core/ipv6 \
	lib/lwip/src/netif

LWIP_SRCS := $(foreach dir,$(LWIP_SRC_DIRS),$(wildcard $(dir)/*.c))
LWIP_OBJS := $(patsubst %.c,%.o,$(LWIP_SRCS))

ALL_OBJS := $(OBJS) $(ARCH_OBJS) $(BIGNUM_OBJS) $(MISC_OBJS) $(PCRE_OBJS) $(LWIP_OBJS)
ALL_OBJS += ling_main.o

ifneq ($(ARCH),posix)
# this is a c file in posix
$(STARTUP_OBJ): %.o: %.$(STARTUP_SRC_EXT)
	$(CC) $(ASFLAGS) $(CPPFLAGS) -c $< -o $@
endif

# Stop iops reordering in ling_main.o
OBJS1 := $(filter-out ling_main.o,$(OBJS))
$(ARCH_OBJS) $(OBJS1) $(BIGNUM_OBJS): %.o: %.c include/atom_defs.h
	$(CC) $(CFLAGS) $(CPPFLAGS) -o $@ -c $<

$(MISC_OBJS): %.o: %.c
	$(CC) $(CFLAGS) $(CPPFLAGS) -o $@ -c $<

$(MISC_AS_OBJS): %.o: %.s
	$(CC) $(ASFLAGS) $(CPPFLAGS) -c $< -o $@

$(PCRE_OBJS): %.o: %.c
	$(CC) $(CFLAGS) $(CPPFLAGS) -DHAVE_CONFIG_H -o $@ -c $<

$(LWIP_OBJS): %.o: %.c
	$(CC) $(CFLAGS) $(CPPFLAGS) -Wno-char-subscripts -o $@ -c $<

ling_main.c: scripts/ling_main_c.et scripts/hot_cold_iops
	scripts/main_gen $^

ling_main.o: ling_main.c include/atom_defs.h
	$(CC) $(CFLAGS) $(CPPFLAGS) $(F_NO_REORDER_BLOCKS) -o $@ -c $<

include/bif.h: ../bc/scripts/bif.tab
	scripts/bifs_gen $< $@

GEN_BEAMS := gentab/atoms.erl gentab/exp_tab.erl
BEAMS := $(patsubst %.erl,%.beam,$(sort $(wildcard gentab/*.erl) $(GEN_BEAMS)))
$(BEAMS): %.beam: %.erl
	erlc -o gentab $<

PREMODS := $(patsubst %.erl,%.beam,$(wildcard preload/*.erl))
$(PREMODS): %.beam: %.erl
	erlc -DLING_VER=\"$(LING_VER)\" -o preload $<

gentab/exp_tab.erl: $(PREMODS) ../bc/scripts/bif.tab
	scripts/exptab_gen preload ../bc/scripts/bif.tab $@

include/atom_defs.h atoms.inc gentab/atoms.erl: scripts/atoms.tab gentab/exp_tab.beam
	scripts/atoms_gen scripts/atoms.tab preload \
		include/atom_defs.h atoms.inc gentab/atoms.erl


premod: $(INCLUDES)
$(INCLUDES): gentab/atoms.beam gentab/exp_tab.beam include/atom_defs.h $(PREMODS)
	scripts/premod_gen preload premod.inc code_base.inc include/mod_info.inc preload/literals.c catch_tab.inc copy

vmling.o: $(STARTUP_OBJ) $(MISC_AS_OBJS) $(ALL_OBJS)
	$(CC) -o $@ $(STARTUP_OBJ) $(MISC_AS_OBJS) $(ALL_OBJS) $(LDFLAGS) $(LDFLAGS_FINAL)

nettle: lib/nettle/libnettle.a

lib/nettle/libnettle.a: lib/nettle/config.h
	$(MAKE) -C lib/nettle

lib/nettle/config.h: lib/nettle.tar.gz
	mkdir -p lib/nettle && tar vxzf $< -C lib/nettle --strip-components=1 && \
	cd lib/nettle && ./configure --disable-public-key --disable-shared --disable-pic --disable-openssl --disable-documentation $(NETTLE_FLAGS) CFLAGS="-fno-stack-protector -U_FORTIFY_SOURCE"

lib/nettle.tar.gz:
	wget -O $@ --no-check-certificate -c https://ftp.gnu.org/gnu/nettle/nettle-2.7.1.tar.gz
