#!/bin/bash

# This script has been created manually

REQ_OTP_REL=R16B01
LING_VER=0.2.3

# Default values
PREFIX=/usr/local

while true; do
	case "$1" in
	--with-prefix=*)
		PREFIX=${1#*=}
		shift
		;;
	--help)
		cat <<EOF
--with-prefix=PREFIX  path prefix for the LING installation
EOF
		exit 0
		;;
	*)
		break
		;;
	esac
done

TEMPS="test.c test.o a.out"
cleanup() {
	rm -f $TEMPS
}
trap cleanup SIGINT SIGTERM

# gcc dependency
echo -ne "checking for gcc... "
if which gcc &>/dev/null; then
	echo yes
else
	echo no
cat <<EOF
--------------------------------------------------------------------------------
gcc not found. LING requires gcc (>= 4.8.1 recommended).
EOF
	cleanup
	exit 1
fi

# Erlang/OTP dependency
echo -ne "checking for erl... "
if which erl &>/dev/null; then
	echo yes
else
	echo no
cat <<EOF
--------------------------------------------------------------------------------
Erlang/OTP not found. LING requires Erlang/OTP $REQ_OTP_REL installed.
EOF
	cleanup
	exit 1
fi

#echo -ne "checking Erlang/OTP release... "
#OTP=`erl -noshell -eval 'erlang:display(erlang:system_info(otp_release)), halt()' |tr -d '\r"'`
#echo -ne "$OTP "
#if [ "$OTP" == "$REQ_OTP_REL" ]; then
#	echo ok
#else
#	echo "(incompatible)"
#	cat <<EOF
#--------------------------------------------------------------------------------
#LING requires a specific version of Erlang/OTP ($REQ_OTP_REL). You may need to build
#it from sources (http://erlang.org).
#EOF
#	exit 1
#fi
#

cat > Config.mk <<EOF
LING_VER := $LING_VER
LING_ROOT := $PREFIX/lib/ling
BIN_DIR := $PREFIX/bin
EOF

cp Makefile.in Makefile

cleanup
echo "Run 'make' to build LING"

#EOF
